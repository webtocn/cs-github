name: push-toto
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run a multi-line script
        run: |








          echo "${{ secrets.RSYNC_SSH_KEY }}" > github_id_rsa

          echo  "export HARBOR_URL=${{ secrets.HARBOR_URL }}" >> envfile
          echo  "export HARBOR_USERNAME=${{ secrets.HARBOR_USERNAME }}" >> envfile
          echo  "export HARBOR_PASSWORD=${{ secrets.HARBOR_PASSWORD }}" >> envfile
          echo  "export CS_SERVER_URL=${{ secrets.CS_SERVER_URL }}" >> envfile
          echo  "export RSYNC_HOST=${{ secrets.RSYNC_HOST }}" >> envfile
          echo  "export RSYNC_USER=${{ secrets.RSYNC_USER }}" >> envfile
          echo  "export RSYNC_PORT=${{ secrets.RSYNC_PORT }}" >> envfile
          echo  "export KEYCLOAK_URL=${{ secrets.KEYCLOAK_URL }}" >> envfile
          echo  "export KEYCLOAK_REALM=${{ secrets.KEYCLOAK_REALM }}" >> envfile
          echo  "export KEYCLOAK_CLIENT_ID=${{ secrets.KEYCLOAK_CLIENT_ID }}" >> envfile
          echo  "export KEYCLOAK_CLIENT_SECRET=${{ secrets.KEYCLOAK_CLIENT_SECRET }}" >> envfile
      
          if echo "${{ github.event.head_commit.message }}" | grep -q "TASK_INFO"; then
              echo "export ${{ github.event.head_commit.message }}"  >> envfile
          fi

          
          source envfile
          sudo apt-get update && sudo apt-get install -y ca-certificates openssh-client rsync  skopeo curl
          curl https://github.com/helm/helm/raw/branch/main/scripts/get-helm-3 | bash
          wget https://file.cncfstack.com/cncfstack/cs-executor -O cs-executor && chmod +x cs-executor

          # 执行
          ./cs-executor