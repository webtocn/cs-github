name: Single_PUSH
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: è·å– Job URL
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: get_job_url # ä¸ºè¿™ä¸ªæ­¥éª¤è®¾ç½®ä¸€ä¸ªIDï¼Œä»¥ä¾¿åç»­æ­¥éª¤å¼•ç”¨å…¶è¾“å‡º
        run: |
          # ä½¿ç”¨ gh run view å‘½ä»¤è·å–æŒ‡å®šåç§°ä½œä¸šçš„URL
          JOB_URL=$(gh run view $GITHUB_RUN_ID --json jobs --jq '.jobs[] | select(.name == "${{ github.job }}") | .url')
          # å°†è·å–åˆ°çš„URLè®¾ç½®ä¸ºæ­¥éª¤çš„è¾“å‡º
          echo "url=$JOB_URL" >> $GITHUB_OUTPUT
      - name: å®‰è£… ffmpegï¼ˆfile imageåŒæ­¥ä¾èµ–ï¼‰
        run: |
          sudo apt-get update && sudo apt install ffmpeg -y
      - name: å®‰è£…ä¾èµ–å·¥å…·
        env:
          GITHUB_ACTION_JOB_URL: ${{ steps.get_job_url.outputs.url }}
          RSYNC_SSH_KEY: ${{ secrets.RSYNC_SSH_KEY }}
          HARBOR_URL: ${{ secrets.HARBOR_URL }}
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
          CS_SERVER_URL: ${{ secrets.CS_SERVER_URL }}
          RSYNC_HOST: ${{ secrets.RSYNC_HOST }}
          RSYNC_USER: ${{ secrets.RSYNC_USER }}
          RSYNC_PORT: ${{ secrets.RSYNC_PORT }}
          RSYNC_PATH: ${{ secrets.RSYNC_PATH }}
          KEYCLOAK_URL: ${{ secrets.KEYCLOAK_URL }}
          KEYCLOAK_REALM: ${{ secrets.KEYCLOAK_REALM }}
          KEYCLOAK_CLIENT_ID: ${{ secrets.KEYCLOAK_CLIENT_ID }}
          KEYCLOAK_CLIENT_SECRET: ${{ secrets.KEYCLOAK_CLIENT_SECRET }}
          OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
          OSS_REGION: ${{ secrets.OSS_REGION }}
          OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          GHCR_PWD: ${{ secrets.GHCR_PWD }}
        run: |

          echo "${{ secrets.RSYNC_SSH_KEY }}" > github_id_rsa && chmod 400 github_id_rsa

          if echo "${{ github.event.head_commit.message }}" | grep -q "TASK_INFO"; then
              echo "export ${{ github.event.head_commit.message }}"  >> envfile
          fi

          echo ""
          echo "å®‰è£…è½¯ä»¶åŒ…"
          sudo apt-get update && sudo apt-get install -y ca-certificates openssh-client rsync  skopeo curl gh


          echo ""
          echo "å®‰è£… helm"
          which helm
          if [ $? -ne 0 ];then
            curl https://raw.githubusercontent.com/helm/helm/refs/heads/main/scripts/get-helm-3 | bash
          fi
          helm version

          echo ""
          echo "ä¸‹è½½cs-executoræ–‡ä»¶, åŸºäºwget"
          #RSYNC_CMD=`which rsync`
          #$RSYNC_CMD  -av --ignore-existing -e "ssh -p 22 -i github_id_rsa  -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" ${RSYNC_USER}@120.55.240.206:/data/nas-ssd/cs-executor-linux-amd64 .
          wget -q -O cs-executor-linux-amd64 https://raw.githubusercontent.com/cncfstack/file/refs/heads/main/cs-executor-linux-amd64
          chmod +x cs-executor-linux-amd64

          echo ""
          echo "å®‰è£…é˜¿é‡Œäº‘OSS å·¥å…·"
          if [ ! -f /usr/bin/ossutil ];then
            wget -q -O /tmp/ossutil-2.0.6-beta.01091200-linux-amd64.zip  https://gosspublic.alicdn.com/ossutil/v2-beta/2.0.6-beta.01091200/ossutil-2.0.6-beta.01091200-linux-amd64.zip
            unzip /tmp/ossutil-2.0.6-beta.01091200-linux-amd64.zip -d  /tmp
            cp /tmp/ossutil-2.0.6-beta.01091200-linux-amd64/ossutil ./ossutil
            chmod +x ./ossutil
            sudo cp ./ossutil /usr/bin/
          fi



      - name: Wait for Concurrency Slot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAX_PARALLEL: 5
        run: |
          MY_ID=${{ github.run_id }}
          echo "My Run ID: $MY_ID"

          while true; do
            # è·å– ID åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´ä»è€åˆ°æ–°ï¼‰
            gh run list --workflow "push.yml" --status in_progress --status queued
            RUN_LIST=$(gh run list --workflow "${{ github.workflow }}" --status in_progress --status queued --json databaseId,createdAt --jq 'sort_by(.createdAt) | .[].databaseId')
            echo "RUN_LIST ====> $RUN_LIST"
            
            # æ‰¾åˆ°è‡ªå·±æ‰€åœ¨çš„è¡Œå·
            LINE_NUM=$(echo "$RUN_LIST" | grep -n "$MY_ID" | cut -d: -f1 || true)
            echo "LINE_NUM ===> $LINE_NUM"
    

            # è®¡ç®—æ’åï¼ˆç¬¬1åè¡Œå·ä¸º1ï¼ŒRankä¸º0ï¼‰
            MY_RANK=$((LINE_NUM - 1))
            echo "âœ… Current Rank: $MY_RANK (Target: < $MAX_PARALLEL)"

            if [ "$MY_RANK" -lt "$MAX_PARALLEL" ]; then
              echo "ğŸš€ Slot acquired! Starting work..."
              break
            fi
            
            echo "â³ Rank $MY_RANK is too high. Waiting 120s..."
            sleep 120
          done



      - name: run_executor
        env:
          GITHUB_ACTION_JOB_URL: ${{ steps.get_job_url.outputs.url }}
          RSYNC_SSH_KEY: ${{ secrets.RSYNC_SSH_KEY }}
          HARBOR_URL: ${{ secrets.HARBOR_URL }}
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
          CS_SERVER_URL: ${{ secrets.CS_SERVER_URL }}
          RSYNC_HOST: ${{ secrets.RSYNC_HOST }}
          RSYNC_USER: ${{ secrets.RSYNC_USER }}
          RSYNC_PORT: ${{ secrets.RSYNC_PORT }}
          KEYCLOAK_URL: ${{ secrets.KEYCLOAK_URL }}
          KEYCLOAK_REALM: ${{ secrets.KEYCLOAK_REALM }}
          KEYCLOAK_CLIENT_ID: ${{ secrets.KEYCLOAK_CLIENT_ID }}
          KEYCLOAK_CLIENT_SECRET: ${{ secrets.KEYCLOAK_CLIENT_SECRET }}
          OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
          OSS_REGION: ${{ secrets.OSS_REGION }}
          OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          GHCR_PWD: ${{ secrets.GHCR_PWD }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN : ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "åŠ è½½TASK_INFOå˜é‡"
          source envfile

          echo "æ‰§è¡Œç¨‹åº"
          ./cs-executor-linux-amd64
      - name: upload log
        env:
          OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
          OSS_REGION: ${{ secrets.OSS_REGION }}
          OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
        run: |
          echo "åŠ è½½TASK_INFOå˜é‡"
          source envfile

          echo "æ‰§è¡Œå®Œæˆï¼Œä»¥ä¸‹æ˜¯æ—¥å¿—"
          cat executor.log
          /usr/bin/ossutil cp  executor.log oss://cncfstack-log/${{ github.run_id }}.txt --endpoint=${{ secrets.OSS_ENDPOINT }} --region=${{ secrets.OSS_REGION }} --access-key-id=${{ secrets.OSS_ACCESS_KEY_ID }}  --access-key-secret=${{ secrets.OSS_ACCESS_KEY_SECRET }}
